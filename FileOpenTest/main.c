#include "..\\include\Lib_Clara.h"
#include "..\\include\Dir.h"
#include "..\\include\dll.h"
#include "..\\Dlls\FileDialog\export\FileDialogDll.h"

#define DLL_DATA FILE_DIALOG
typedef struct
{
  BOOK * book;
}MSG;


DLL_DATA * FILE_DIALOG_THIS;

void elf_exit(void)
{
  kill_data(&ELF_BEGIN, (void(*)(void*))mfree_adr());
}



//Убийство эльфа
int TerminateElf(void * ,BOOK * book)
{
  FreeBook(book);
  return(1);
}

//Показать информацию об авторе
int ShowAuthorInfo(void *mess ,BOOK * book)
{
  MSG * msg = (MSG*)mess;
  MessageBox(EMPTY_TEXTID,STR("OFD Dll Test..."),NOIMAGE, 1 ,5000,msg->book);
  return(1);
}


static int onCancel(void *mess ,BOOK *book)
{
  StatusIndication_ShowNotes(EMPTY_TEXTID);
  FreeBook(book);
  return(1);
}
static int onAccept(void *mess ,BOOK *book)
{
  FILEITEM * fi = (FILEITEM *)mess;
  FSTAT fs;
  wchar_t ws[0x200];
  fstat( FILEITEM_GetPath(fi), FILEITEM_GetFname(fi),&fs);
  if ((fs.st_mode&FSX_S_IFDIR))
    snwprintf(ws,0x1ff,L"Selected folder : %ls/%ls", FILEITEM_GetPath(fi), FILEITEM_GetFname(fi))  ;
  else
    snwprintf(ws,0x1ff,L"Selected file : %ls/%ls", FILEITEM_GetPath(fi), FILEITEM_GetFname(fi))  ;

  StatusIndication_ShowNotes(TextID_Create(ws,ENC_UCS2,TEXTID_ANY_LEN));
  FreeBook(book);
  return(1);
}

const PAGE_MSG OFD_PageEvents[]@ "DYN_PAGE" ={
  ELF_TERMINATE_EVENT , TerminateElf,
  ELF_SHOW_INFO_EVENT  , ShowAuthorInfo,

  ACCEPT_EVENT_TAG, onAccept,
  CANCEL_EVENT_TAG, onCancel,
  NIL_EVENT_TAG,0
};

PAGE_DESC OFDbase_page ={"OFD_BasePage",0,OFD_PageEvents};


void onCloseOFDBook(BOOK * CLBook)
{
  UnLoadDLL(FILE_DIALOG_THIS);
  SUBPROC(elf_exit);
}

BOOK * CreateOFDBook()
{
  BOOK * OFDBook = new BOOK;
  CreateBook(OFDBook,onCloseOFDBook,&OFDbase_page,"OFD TEST",-1,0);
  return(OFDBook);
}


int main (u16 * fn)
{
  wchar_t wstr[100];

  FILE_DIALOG_THIS = (DLL_DATA *)LoadDLL(L"FileDialogDll.dll");

  if ((INVALID(FILE_DIALOG_THIS)))
  {
    snwprintf(wstr,99,L"Error Load FileDialogDll.dll : %d",FILE_DIALOG_THIS);
    MessageBox(EMPTY_TEXTID,TextID_Create(wstr,ENC_UCS2,TEXTID_ANY_LEN),NOIMAGE, 1,0,0);
    return NULL;

  }

  FILE_DIALOG_Create(FILE_DIALOG_THIS,
                     CreateOFDBook(),
                     OFD_OPEN_FILE_DIALOG | OFD_SELECT_FOLDER,
                     L"Header",
                     L"*.*",
                     DIR_VIDEO,
                     DIR_AUDIO,
                     -1
                     );

  return(0);
}
